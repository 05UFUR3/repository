#include <Wire.h>
#include <RTClib.h>

RTC_DS3231 rtc;

const int relayPin = 7;  // リレー制御ピン
const int buttonPin = 4; // ストップボタン

// --- 毎日固定の動作時刻 ---
int targetHour = 7;     // 7時
int targetMinute = 30;  // 30分
// ----------------------------

bool alreadyDone = false;

void setup() {
  Serial.begin(9600);
  rtc.begin();

  pinMode(relayPin, OUTPUT);
  digitalWrite(relayPin, LOW); // リレーOFF

  pinMode(buttonPin, INPUT_PULLUP); // ボタン（押したらLOW）
}

void loop() {
  DateTime now = rtc.now();
  int h = now.hour();
  int m = now.minute();

  // 指定時刻になったら動作
  if (h == targetHour && m == targetMinute && !alreadyDone) {
    pumpStart();
    alreadyDone = true;
  }

  // 分が変わったら翌日用にリセット
  if (m != targetMinute) {
    alreadyDone = false;
  }

  // ポンプ動いてる間にボタンを押したら停止
  if (pumpRunning() && isButtonPressed()) {
    pumpStop();
  }

  delay(200);
}

// ---- ポンプ制御 ----

bool isPumpOn = false;

void pumpStart() {
  Serial.println("Pump ON");
  digitalWrite(relayPin, HIGH);  // リレーON（逆ならLOWにする）
  isPumpOn = true;
}

void pumpStop() {
  Serial.println("Pump OFF");
  digitalWrite(relayPin, LOW);   // リレーOFF
  isPumpOn = false;
}

bool pumpRunning() {
  return isPumpOn;
}

bool isButtonPressed() {
  return digitalRead(buttonPin) == LOW; // 押されたらLOW
}
